<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Itswr Customer</title>
<!-- Icon -->
<link rel="shortcut icon" type="image/x-icon" href="assets/favicon.ico" />
<!-- 全局CSS -->
<link rel="stylesheet" href="assets/hplus/css/bootstrap.min.css" />
<link rel="stylesheet" href="assets/hplus/css/font-awesome.css" />
<link rel="stylesheet" href="assets/hplus/css/animate.css" />
<!-- 自定义CSS -->
<link rel="stylesheet" href="assets/hplus/css/style.css" />
<!-- 第三方CSS -->
<!-- <link rel="stylesheet" href="assets/lib/animate/3.5.2/animate.css" > -->
<link rel="stylesheet" href="assets/hplus/css/plugins/iCheck/custom.css" />
<link rel="stylesheet" href="assets/hplus/css/plugins/toastr/toastr.min.css" />
<link rel="stylesheet" href="assets/lib/layer/3.0.3/skin/default/layer.css" />
<link rel="stylesheet" href="assets/lib/jquery/jquery.datatables/1.10.15/css/dataTables.bootstrap.min.css" />
<link rel="stylesheet" href="assets/lib/jquery/jquery.datatables/FixedHeader-3.1.2/css/fixedHeader.bootstrap.min.css" />
<link rel="stylesheet" href="assets/lib/zTree/3.5.29/css/metroStyle/metroStyle.css" />
<!-- 我的CSS -->
<link rel="stylesheet" href="assets/mrathena.css" />
<link rel="stylesheet" href="assets/custom.css" />
</head>
<body class="gray-bg">

	<div class="p10 animated fadeInRight">
		<div class="row">
			<div class="col-sm-12">
				<div class="panel panel-default mb10">
					<div class="panel-body">
						<form id="parameter" class="form-inline">
							<button type="button" class="btn btn-sm btn-outline btn-info refresh">刷新页面</button>
							<span class="btn-sm">|</span>
							<div class="input-group">
								<input type="text" name="startNo" class="form-control" style="width:120px;" placeholder="起始CD号"/>
								<span class="input-group-btn">
									<button type="button" class="btn btn-white clear">×</button>
								</span>
							</div>
							<div class="input-group">
								<input type="text" name="count" class="form-control" style="width:120px;" placeholder="爬取数量" value="100"/>
								<span class="input-group-btn">
									<button type="button" class="btn btn-white clear">×</button>
								</span>
							</div>
							<button type="button" id="reset2" class="btn btn-sm btn-info btn-outline">重置</button>
							<button type="button" id="new" class="btn btn-sm btn-info btn-outline">新建任务</button>
						</form>
						<div id="progress" class="ibox float-e-margins mb0" style="display: none;">
			                <div class="p0 pt5" style="border-top: 0;">
			                    <div class="progress progress-striped active mb0">
			                        <div id="progress-bar" style="width: 70%" aria-valuemax="10000" aria-valuemin="0" aria-valuenow="75" role="progressbar" class="progress-bar progress-bar-info">
			                            <span class="sr-only">40% Complete (success)</span>
			                        </div>
			                    </div>
			                </div>
			            </div>
					</div>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-sm-12">
				<div class="panel panel-default mb10">
					<div class="panel-body">
						<form id="condition" class="form-inline">
							<button type="button" class="btn btn-sm btn-outline btn-info refresh">刷新页面</button>
							<span class="btn-sm">|</span>
							<div class="input-group">
								<input type="text" name="startNo" class="form-control" style="width:120px;" placeholder="起始CD号"/>
								<span class="input-group-btn">
									<button type="button" class="btn btn-white clear">×</button>
								</span>
							</div>
							<button type="button" id="reset" class="btn btn-sm btn-info btn-outline">重置</button>
							<button type="button" id="search" class="btn btn-sm btn-info btn-outline">搜索</button>
						</form>
					</div>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-sm-12">
				<div class="panel panel-default">
					<div class="panel-body">
						<table id="table" class="table table-hover table-bordered text-12" style="width:100%;"></table>
					</div>
				</div>
			</div>
		</div>
	</div>
	
<!-- 全局JS -->
<script src="assets/hplus/js/jquery.min.js"></script>
<script src="assets/hplus/js/bootstrap.min.js"></script>
<script src="assets/hplus/js/plugins/metisMenu/jquery.metisMenu.js"></script>
<script src="assets/hplus/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
<!-- 自定义js -->
<script src="assets/hplus/js/hplus.js"></script>
<script src="assets/hplus/js/content.js"></script>
<!-- 第三方JS -->
<script src="assets/hplus/js/plugins/pace/pace.min.js"></script>
<script src="assets/hplus/js/plugins/iCheck/icheck.min.js"></script>
<script src="assets/hplus/js/plugins/toastr/toastr.min.js"></script>
<script src="assets/lib/layer/3.0.3/layer.min.js"></script>
<script src="assets/lib/jquery/jquery.datatables/1.10.15/js/jquery.dataTables.min.js"></script>
<script src="assets/lib/jquery/jquery.datatables/1.10.15/js/dataTables.bootstrap.min.js"></script>
<script src="assets/lib/jquery/jquery.datatables/FixedHeader-3.1.2/js/dataTables.fixedHeader.min.js"></script>
<script src="assets/lib/jquery/jquery.validate/1.16.0/jquery.validate.min.js"></script>
<script src="assets/lib/jquery/jquery.validate/1.16.0/localization/messages_zh.min.js"></script>
<script src="assets/lib/jquery/jquery.serialize/2.5.0/jquery.serialize-object.min.js"></script>
<script src="assets/lib/zTree/3.5.29/js/jquery.ztree.all.js"></script>
<!-- 我的JS -->
<script src="assets/mrathena.js"></script>
<script src="assets/custom.js"></script>
<script>
var handles = new Array();
$(document).ready(function() {
	// 初始化datatables数据
	var dt = $('#table').dataTable({
		serverSide: true,
		processing: true,
		ajax: {
			url: "customer/list",
			type: "post"
		},
		columns: [
			{
				width: 18,
				orderable: false,
				title: '<div style="width:18px;height:18px;"><input type="checkbox" class="checkOrUncheckAllItems" /></div>',
				data: function(row, type, set, meta) {
					var html = '<div style="width:18px;height:18px;"><input type="checkbox" class="item" data-id="'+row.id+'" data-username="'+row.username+'" /></div>';
					return html;
				}
			},
            {
				title: "编号",
				data: 'no'
			},
            {
				title: "姓名",
				data: 'name'
			},
            {
				title: "邮箱",
				data: 'email'
			},
            {
				title: "主号码",
				data: 'number'
			},
            {
				title: "次号码",
				data: 'number2'
			},
           	{	
				title: "状态",
				data: 'status',
				render: function(data, type, row, meta) {
            		return data == "SUCCESS" ? "成功" : "失败";
            	}
            },
            {
				title: "失败原因",
				data: 'reason'
			},
        ],
        searching: false,
        ordering: false,
        paging: true,
		pagingType: "full_numbers",
		lengthMenu: [[10, 15, 20, 25, 50, 100], [10, 15, 20, 25, 50, 100]],
		stateSave: false,
		autoWidth: true,
		fixedHeader: true,
        scrollX: true,
		language: datatables.language,
		drawCallback: function() {
			$("input[type=checkbox]").iCheck("uncheck").iCheck({
				checkboxClass : 'icheckbox_square-green',
				radioClass : 'iradio_square-green'
			});
	    }
	});
	// 表格全选操作
	$(document).on("ifChanged", ".checkOrUncheckAllItems", function() {
		var status = $(this).prop("checked") ? "check" : "uncheck";
		$("input[type=checkbox].item").iCheck(status);
	});
	// 页面基本操作
	$(document).on("click", ".clear", function() {
		$(this).parent().prev().val("");
	});
	$(document).on("click", "#reset", function() {
		$("#condition input[type=text],#condition select").each(function(i) {
			$(this).val("");
		});
		dt.fnSettings().ajax.data = $("#condition").serializeObject();
		dt.api().ajax.reload();
	});
	$(document).on("click", "#search", function() {
		dt.fnSettings().ajax.data = $("#condition").serializeObject();
		dt.api().ajax.reload();
	});
	$(document).on("click", ".refresh", function() {
		window.location.reload();
	})
	$(document).on("click", "#reset2", function() {
		$("#parameter input[type=text]").each(function(i) {
			$(this).val("");
		});
	});
	$(document).on("click", "#new", function() {
		var value = 0;
		$("#progress-bar").css("width", value).attr("aria-valuenow", value);
		$("#progress").show();
		var handle = setInterval("clock()", 1000);
		handles.push(handle);
		$.postJson("customer/crawl", $("#parameter").serializeObject(), true, function(response) {
			if(response != "任务执行结束") {
				for(i = 0, len=handles.length; i < len; i++) {
					window.clearInterval(handles[i]);
				}
				handles = new Array();
				$.msg.error(response);
			} else {
				$.msg.info(response);
				// 刷新表格
				dt.fnSettings().ajax.data = $("#condition").serializeObject();
				dt.api().ajax.reload();
			}
		}, function() {
			$.msg.error("请稍后重试或联系系统管理员解决", "系统异常");
		});
	});
});
function clock() {
	$.postJson("customer/status", null, false, function(response) {
		if(response.status == "当前没有正在执行的任务") {
			for(i = 0, len=handles.length; i < len; i++) {
				window.clearInterval(handles[i]);
			}
			handles = new Array();
			$("#progress").hide();
			$.log("任务进度:100%");
		} else {
			var value = (response.success + response.failure) / response.total;
			$("#progress-bar").css("width", value * 100 + "%").attr("aria-valuenow", value * 10000);
			$.log("状态:"+response.status, "总数:"+response.total, "成功:"+response.success, "失败:"+response.failure, "进度:"+(value*100)+"%");
		}
	}, function() {
		$.msg.error("请稍后重试或联系系统管理员解决", "系统异常");
	});
};
</script>
</body>
</html>